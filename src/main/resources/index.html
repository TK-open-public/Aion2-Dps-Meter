<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>DPS</title>
    <link
        href="styles.css"
        rel="stylesheet"
        type="text/css"/>
    <link
        rel="stylesheet"
        href="./lib/SpoqaHanSansNeo.min.css"/>
    <script src="./lib/vue.global.js"></script>
<!--    <script src="./lib/vue.min.js"></script>-->
    <script src="./lib/lucide.min.js"></script>
</head>

<body>
<div class="container">
    <div id="app"></div>
</div>

<script src="./js/dps.js"></script>
<script src="./components/headerArea.js"></script>
<script src="./components/meterArea.js"></script>
<script src="./components/detailArea.js"></script>

<script>
  const {createApp, ref, onMounted, onUnmounted, watch} = Vue;
  const INACTIVE_MS = 20000;

  createApp({
    components: {
      HeaderArea: window.HeaderArea,
      MeterArea: window.MeterArea,
      DetailArea: window.DetailArea
    },
    setup() {
      const isCollapse = ref(false);
      const isDetailOpen = ref(false);
      const detailRowId = ref("");
      const dpsDatas = ref([]);
      const targetName = ref("");
      let intervalId = null;

      const isDragging = ref(false);
      const startX = ref(0);
      const startY = ref(0);
      const initialStageX = ref(0);
      const initialStageY = ref(0);

      const fightState = ref("state-grace");
      const isFight = ref(false);
      const fightStartAt = ref(0);
      const lastActiveAt = ref(0);
      const fightEndAt = ref(0);

      // 리셋버튼 이벤트
      const resetClick = () => {
        isCollapse.value = false;
        isDetailOpen.value = false;
        detailRowId.value = "";
        dpsDatas.value = [];
        targetName.value = "";

        fightState.value = "";
        isFight.value = false;
        fightStartAt.value = 0;
        lastActiveAt.value = 0;
        fightEndAt.value = 0;
      };

      // 정렬 이벤트
      const collapseClick = () => {
        isCollapse.value = !isCollapse.value;
        dpsDatas.value.reverse();
      };

      //리스트에서 유저클릭시 이벤트
      const onClickUserRow = (row) => {
        if(row.id) {
          detailRowId.value = row.id;
          isDetailOpen.value = true;
        }
      }

      // 창 이동 이벤트
      const handleMouseDown = (e) => {
        isDragging.value = true;
        startX.value = e.screenX;
        startY.value = e.screenY;
        initialStageX.value = window.screenX;
        initialStageY.value = window.screenY;
      };

      const handleMouseMove = (e) => {
        if (isDragging.value && window.javaBridge) {
          const deltaX = e.screenX - startX.value;
          const deltaY = e.screenY - startY.value;

          window.javaBridge.moveWindow(
            initialStageX.value + deltaX,
            initialStageY.value + deltaY
          );
        }
      };

      const handleMouseUp = () => {
        isDragging.value = false;
      };

      // dps 풀링 시작
      const startPolling = () => {
        const initPolling = () => {
          if (window.dpsData && window.dpsData.getDpsData) {
            intervalId = setInterval(() => {
              if (!window.dpsData || !window.dpsData.getDpsData) {
                return;
              }

              const raw = window.dpsData.getDpsData() || [];
              if (typeof raw !== "string") return;

              let { rows, targetName : newTargetName } = buildRowsFromPayload(raw);

              dpsDatas.value = rows;
              targetName.value = newTargetName;
            }, 200);
          } else {
            console.log("dpsData 없음");
          }
        };

        // 이미 준비되어 있으면 바로 실행
        if (window.dpsData) {
          initPolling();
        } else {
          console.log("javaReady 이벤트 대기 중...");

          window.addEventListener('javaReady', () => {
            console.log("javaReady 이벤트 수신!");
            initPolling();
          }, { once: true });
        }
      };

      const stopPolling = () => {
        if (intervalId) {
          clearInterval(intervalId);
          intervalId = null;
        }
      };

      // 미터기 상세 창 닫기 이벤트
      const detailClose = () => {
        isDetailOpen.value = false;
        detailRowId.value = "";
      }

      // 배틀 시간 계산
      watch(dpsDatas, (newVal) => {
        const isActivity = computedDps(newVal);
        const now = performance.now() || Date.now();

        if(isActivity) {
          if(fightStartAt.value === 0) {
            isFight.value = true;
            fightStartAt.value = now;
            lastActiveAt.value = now;
            fightEndAt.value = 0;
            fightState.value = "state-fighting";
          } else {
            if(isFight.value) {
              lastActiveAt.value = now;
            }
          }
        } else {
          if(isFight.value) {
            const inactiveMs = now - lastActiveAt;
            if (inactiveMs >= INACTIVE_MS) {
              isFight.value = false;
              fightEndAt.value = lastActiveAt - fightStartAt.value; // 전투시간
              fightStartAt.value = 0;
              fightState.value = "state-ended";
            } else if (inactiveMs >= 1000) {
              fightState.value = "state-grace";
            }
          }
        }
      }, { deep: true });

      const formatMMSS = (ms) => {
        const sec = Math.max(0, Math.floor(ms / 1000));
        const mm = String(Math.floor(sec / 60)).padStart(2, "0");
        const ss = String(sec % 60).padStart(2, "0");
        return `${mm}:${ss}`;
      };

      onMounted(() => {
        document.addEventListener("mousedown", handleMouseDown);
        document.addEventListener("mousemove", handleMouseMove);
        document.addEventListener("mouseup", handleMouseUp);
        startPolling();
      });

      onUnmounted(() => {
        document.removeEventListener("mousedown", handleMouseDown);
        document.removeEventListener("mousemove", handleMouseMove);
        document.removeEventListener("mouseup", handleMouseUp);
        stopPolling();
      });

      return {
        isCollapse,
        isDetailOpen,
        dpsDatas,
        targetName,
        detailRowId,
        fightState,
        isFight,
        fightStartAt,
        lastActiveAt,
        fightEndAt,
        resetClick,
        collapseClick,
        onClickUserRow,
        detailClose,
        formatMMSS
      };
    },
    template: `
      <div class="meter">
        <HeaderArea :targetName="targetName" :isCollapse="isCollapse" @resetClick="resetClick"
                    @collapseClick="collapseClick"/>

        <MeterArea @onClickUserRow="onClickUserRow" :rows="dpsDatas"/>

        <div class="battleTime" :class="[fightState]">
          <div class="status"></div>
          <div class="tick">{{ formatMMSS(isFight ? lastActiveAt - fightStartAt : fightEndAt) }}</div>
        </div>

        <div class="console"
             style="
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: lime;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
          "></div>
      </div>

      <DetailArea  @closeClick="detailClose" :isDetailOpen="isDetailOpen" :id="detailRowId" :combatTime="formatMMSS(isFight ? lastActiveAt - fightStartAt : fightEndAt)"/>
    `
  }).mount('#app');
</script>
</body>
</html>
